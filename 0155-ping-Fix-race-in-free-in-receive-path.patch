From 9ed70a2071c3384142a5773d3d47b56964b83107 Mon Sep 17 00:00:00 2001
From: Stefan Guendhoer <stefan@guendhoer.com>
Date: Thu, 7 Jan 2016 17:02:00 +0000
Subject: [PATCH 0155/1168] ping: Fix race in free in receive path

Former-commit-id: e995d8c31d8f8ca02acbd90461ffdb092460cb00
---
 net/ipv4/ping.c | 5 ++++-
 1 file changed, 4 insertions(+), 1 deletion(-)

diff --git a/net/ipv4/ping.c b/net/ipv4/ping.c
index 23895c5..7e345a2 100644
--- a/net/ipv4/ping.c
+++ b/net/ipv4/ping.c
@@ -965,10 +965,13 @@ void ping_rcv(struct sk_buff *skb)
 
 	sk = ping_lookup(net, skb, ntohs(icmph->un.echo.id));
 	if (sk != NULL) {
+		struct sk_buff *skb2 = skb_clone(skb, GFP_ATOMIC);
+
 #ifdef CONFIG_MTK_NET_LOGGING  
 		printk(KERN_INFO "[mtk_net][ping_debug]rcv on sk %p\n", sk);
 #endif
-		ping_queue_rcv_skb(sk, skb_get(skb));
+		if (skb2)
+			ping_queue_rcv_skb(sk, skb2);
 		/*mtk_net: don't put sock here, do sock_put after free skb*/
 		/* sock_put(sk); */
 		return;
-- 
2.7.4

