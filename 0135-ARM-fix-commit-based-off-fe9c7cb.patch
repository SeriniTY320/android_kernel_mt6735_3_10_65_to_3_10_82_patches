From 9f585582f44aa680478fbe7d30d440e2544c539a Mon Sep 17 00:00:00 2001
From: Levin Calado <levincalado@gmail.com>
Date: Wed, 14 Oct 2015 21:05:34 +0800
Subject: [PATCH 0135/1168] ARM: fix commit based off fe9c7cb

Signed-off-by: Levin Calado <levincalado@gmail.com>
Signed-off-by: Stefan Guendhoer <stefan@guendhoer.com>

Former-commit-id: a17dba221ba60217cf06a992818791b7abf54909
---
 arch/arm/include/asm/memory.h | 19 +++++++++++++++++++
 arch/arm/kernel/head.S        |  2 +-
 2 files changed, 20 insertions(+), 1 deletion(-)

diff --git a/arch/arm/include/asm/memory.h b/arch/arm/include/asm/memory.h
index d847cbb..30c7d7e 100644
--- a/arch/arm/include/asm/memory.h
+++ b/arch/arm/include/asm/memory.h
@@ -144,8 +144,25 @@
  * PLAT_PHYS_OFFSET and not PHYS_OFFSET.
  */
 #ifndef PLAT_PHYS_OFFSET
+#if defined(CONFIG_ARM_PATCH_PHYS_VIRT) || defined(CONFIG_NEED_MACH_MEMORY_H)
+/*
+ * we can't have CONFIG_PHYS_OFFSET defined in a case where either
+ * CONFIG_ARM_PATCH_PHYS_VIRT or CONFIG_NEED_MACH_MEMORY_H is defined.
+ * In such a case, if PLAT_PHYS_OFFSET is not defined, try to fall back
+ * to PHYS_OFFSET defined with CONFIG_NEED_MACH_MEMORY_H if present.
+ */
+#if defined(CONFIG_NEED_MACH_MEMORY_H) && defined(PHYS_OFFSET)
+#define PLAT_PHYS_OFFSET	UL(PHYS_OFFSET)
+#else
+/* perhaps we should throw an error?
+ * this looks serious guys... no, seriously.
+ * don't have enuf knowledge to properly fix this thou.
+ */
+#endif
+#else
 #define PLAT_PHYS_OFFSET	UL(CONFIG_PHYS_OFFSET)
 #endif
+#endif
 
 #ifndef __ASSEMBLY__
 
@@ -190,7 +207,9 @@ static inline unsigned long __phys_to_virt(unsigned long x)
 }
 #else
 
+#if !defined(CONFIG_NEED_MACH_MEMORY_H) && !defined(PHYS_OFFSET)
 #define PHYS_OFFSET	PLAT_PHYS_OFFSET
+#endif
 
 #define __virt_to_phys(x)	((x) - PAGE_OFFSET + PHYS_OFFSET)
 #define __phys_to_virt(x)	((x) - PHYS_OFFSET + PAGE_OFFSET)
diff --git a/arch/arm/kernel/head.S b/arch/arm/kernel/head.S
index 3a63c46..b42251a 100644
--- a/arch/arm/kernel/head.S
+++ b/arch/arm/kernel/head.S
@@ -110,7 +110,7 @@ ENTRY(stext)
 	sub	r4, r3, r4			@ (PHYS_OFFSET - PAGE_OFFSET)
 	add	r8, r8, r4			@ PHYS_OFFSET
 #else
-	ldr	r8, =PLAT_PHYS_OFFSET		@ always constant in this case
+	ldr	r8, =PHYS_OFFSET		@ always constant in this case
 #endif
 
 	/*
-- 
2.7.4

